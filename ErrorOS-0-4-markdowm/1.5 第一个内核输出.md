## 1.5 ç¬¬ä¸€ä¸ªå†…æ ¸è¾“å‡º

#### åœ¨kernel_mainä¸­è¾“å‡ºæ¬¢è¿ä¿¡æ¯

**æ­¥éª¤ 1ï¼šå£°æ˜æ¨¡å—**

åœ¨ `os/src/lib.rs` ä¸­æ·»åŠ ï¼š

```rust
pub mod serial;      // ä¸²å£é©±åŠ¨
pub mod console;     // æ§åˆ¶å°è¾“å‡º
```

**æ­¥éª¤ 2ï¼šå®ç°ä¸´æ—¶çš„ `without_interrupts`**

åœ¨å®ç°ç¬¬2ç« çš„ä¸­æ–­ç³»ç»Ÿä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¸´æ—¶å®ç°ã€‚åœ¨ `lib.rs` ä¸­æ·»åŠ ï¼š

```rust
pub mod interrupts {
    pub fn without_interrupts<F, R>(f: F) -> R
    where
        F: FnOnce() -> R,
    {
        // ä¸´æ—¶å®ç°ï¼šç›´æ¥æ‰§è¡Œé—­åŒ…
        // ç¬¬2ç« ä¼šå®ç°çœŸæ­£çš„ä¸­æ–­ç¦ç”¨
        f()
    }
}
```

**æ­¥éª¤ 3ï¼šä¿®æ”¹ `kernel_main`**

åœ¨ `main.rs` ä¸­ä¿®æ”¹ï¼š

```rust
use os::println;

#[no_mangle]
pub extern "C" fn kernel_main() -> ! {
    println!("Welcome to Error OS!");
    println!("Hello from RISC-V kernel!");

    loop {}
}
```

---

#### éªŒè¯ QEMU ä¸­çš„è¾“å‡º

**æ­¥éª¤ 1ï¼šç¼–è¯‘å†…æ ¸**

```bash
cd os
cargo build --release
```

**æ­¥éª¤ 2ï¼šè¿è¡Œ QEMU**

```bash
qemu-system-riscv64 \
    -machine virt \
    -cpu rv64 \
    -smp 1 \
    -m 128M \
    -bios default \
    -nographic \
    -serial mon:stdio \
    -kernel target/riscv64imac-unknown-none-elf/release/os
```

æˆ–ä½¿ç”¨é¡¹ç›®æ ¹ç›®å½•çš„ `run.sh` è„šæœ¬ï¼š

```bash
./run.sh
```

**é¢„æœŸè¾“å‡º**

```
OpenSBI v1.x
   ____                    _____ ____ _____
  / __ \                  / ____|  _ \_   _|
 | |  | |_ __   ___ _ __ | (___ | |_) || |
 | |  | | '_ \ / _ \ '_ \ \___ \|  _ < | |
 | |__| | |_) |  __/ | | |____) | |_) || |_
  \____/| .__/ \___|_| |_|_____/|____/_____|
        | |
        |_|

Platform Name             : riscv-virtio,qemu
...

Boot HART MIDELEG         : 0x0000000000000222
Boot HART MEDELEG         : 0x000000000000b109

Welcome to Error OS!
Hello from RISC-V kernel!
```

**é€€å‡º QEMU**: æŒ‰ `Ctrl+A`ï¼Œç„¶åæŒ‰ `X`

---

#### æµ‹è¯•ä¸åŒæ ¼å¼çš„è¾“å‡º

**æ­¥éª¤ 1ï¼šæµ‹è¯•å„ç§æ ¼å¼åŒ–è¾“å‡º**

ä¿®æ”¹ `kernel_main`:

```rust
#[no_mangle]
pub extern "C" fn kernel_main() -> ! {
    println!("Welcome to Error OS!");
    println!();  // ç©ºè¡Œ

    // æµ‹è¯•æ ¼å¼åŒ–è¾“å‡º
    println!("Testing format output:");
    println!("  Decimal: {}", 42);
    println!("  Hex: {:#x}", 0xdeadbeef);
    println!("  Binary: {:#b}", 0b1010);
    println!("  Boolean: {}", true);

    // æµ‹è¯• serial_print! å®
    serial_println!("[SERIAL] This is serial output");

    // æµ‹è¯•ä¸å¸¦æ¢è¡Œçš„è¾“å‡º
    print!("Loading");
    for _ in 0..3 {
        print!(".");
    }
    println!(" Done!");

    println!("\nKernel initialization complete!");

    loop {}
}
```

**æ­¥éª¤ 2ï¼šç¼–è¯‘è¿è¡Œ**

```bash
cargo build --release
qemu-system-riscv64 -machine virt -cpu rv64 -m 128M -bios default -nographic -serial mon:stdio -kernel target/riscv64imac-unknown-none-elf/release/os
```

**é¢„æœŸè¾“å‡º**

```
Welcome to Error OS!

Testing format output:
  Decimal: 42
  Hex: 0xdeadbeef
  Binary: 0b1010
  Boolean: true
[SERIAL] This is serial output
Loading... Done!

Kernel initialization complete!
```

---

**ğŸ” çŸ¥è¯†ç‚¹ï¼šprintln! å®çš„å±•å¼€è¿‡ç¨‹**

```rust
println!("x = {}", 42);
```

å±•å¼€ä¸ºï¼š

```rust
print!("{}\n", format_args!("x = {}", 42));
```

è¿›ä¸€æ­¥å±•å¼€ï¼š

```rust
$crate::console::_print(format_args!("{}\n", format_args!("x = {}", 42)));
```

æœ€ç»ˆè°ƒç”¨ï¼š

```rust
crate::console::_print(/* æ ¼å¼åŒ–å‚æ•° */);
  â†’ WRITER.lock().write_fmt(args)
    â†’ Writer::write_string(s)
      â†’ Writer::write_to_serial(byte)
        â†’ SERIAL1.lock().write_char(byte)
          â†’ SerialPort::send(byte)
            â†’ å†™å…¥ UART THR å¯„å­˜å™¨
```

---

#### å®éªŒéªŒè¯

#### å®Œæ•´æ€§æ£€æŸ¥æ¸…å•

åœ¨ç»§ç»­ä¸‹ä¸€ç« ä¹‹å‰ï¼Œè¯·ç¡®è®¤ä»¥ä¸‹åŠŸèƒ½æ­£å¸¸ï¼š

```bash
# 1. ç¼–è¯‘æ— é”™è¯¯
cargo build --release

# 2. æŸ¥çœ‹ç¬¦å·è¡¨
riscv64-unknown-elf-nm target/riscv64imac-unknown-none-elf/release/os | grep -E "(_start|kernel_main)"

# 3. æŸ¥çœ‹æ®µä¿¡æ¯
riscv64-unknown-elf-objdump -h target/riscv64imac-unknown-none-elf/release/os

# 4. è¿è¡Œæµ‹è¯•
cargo run --release
```

#### æµ‹è¯•ç¨‹åº

åˆ›å»ºä¸€ä¸ªç»¼åˆæµ‹è¯•ç¨‹åºï¼š

```rust
#[no_mangle]
pub extern "C" fn kernel_main() -> ! {
    // æµ‹è¯•1ï¼šåŸºæœ¬è¾“å‡º
    println!("========================================");
    println!("  Error OS v0.1.0");
    println!("  RISC-V 64 Kernel");
    println!("========================================");
    println!();

    // æµ‹è¯•2ï¼šæ ¼å¼åŒ–è¾“å‡º
    println!("[TEST] Format output:");
    println!("  Integer: {}", 12345);
    println!("  Hex: {:#x}", 0xABCD);
    println!("  Pointer: {:p}", 0x80200000 as *const u8);

    // æµ‹è¯•3ï¼šä¸²å£è¾“å‡º
    serial_println!("[SERIAL] Direct serial output test");

    // æµ‹è¯•4ï¼šæ··åˆè¾“å‡º
    print!("Progress: [");
    for i in 0..10 {
        print!("#");
        if i < 9 {
            print!(" ");
        }
    }
    println!("] 100%");

    println!();
    println!("All tests passed!");
    println!("System ready. Press Ctrl+A then X to exit QEMU.");

    loop {}
}
```
