## 2.1 RISC-V特权级架构

在开始实现中断系统之前，我们需要理解 RISC-V 的特权级架构。这是操作系统设计的基础。

#### 理解 M/S/U 三种特权级

**什么是特权级？**

特权级（Privilege Level）是 CPU 提供的一种访问控制机制，实现系统资源隔离与安全控制，类似于不同级别的"权限"。就像在公司里，员工、经理、CEO 有不同的权限一样，CPU 也将代码分为不同的特权级别。

**RISC-V 的三种特权级**

RISC-V 定义了三种特权级：

1. **机器模式（M-mode）**

这是 RISC-V 架构中权限最高的特权级，能访问所有内存区域、外设以及全部控制状态寄存器，还可执行所有特权指令并处理所有中断和异常。该模式通常用于系统最底层的初始化与控制。openSBI运行在这里。

2. **监管者模式（S-mode）**

属于中等特权级，需依赖 M 模式的支持。该模式主要用于运行操作系统的内核，负责管理系统的核心资源，像进程调度、内存页表管理、设备驱动控制等核心操作均在此模式下完成。

3. **用户模式（U-mode）**

这是权限最低的特权级，用户编写的应用程序、各类应用软件均在此模式下运行。该模式下的程序只能访问自身的用户内存空间，无法直接操作硬件资源或修改系统核心状态，也不能执行特权指令。

**如何切换特权级？**

特权级的切换是通过**异常**和**中断**来实现的：

```
U-mode → S-mode：用户程序执行 ecall 指令（系统调用）
S-mode → U-mode：内核执行 sret 指令（从异常返回）

S-mode → M-mode：内核执行 ecall 指令（SBI 调用）
M-mode → S-mode：固件执行 mret 指令（从异常返回）
```

---

#### 学习 CSR 寄存器

CSR（Control and Status Register，控制状态寄存器）是 RISC-V 中的特殊寄存器，用于控制 CPU 行为和保存状态信息。

**如何访问 CSR？**

RISC-V 提供了专门的指令来访问 CSR：

```assembly
csrrw  rd, csr, rs1    # 读写 CSR：rd = csr; csr = rs1
csrrs  rd, csr, rs1    # 读并置位：rd = csr; csr |= rs1
csrrc  rd, csr, rs1    # 读并清位：rd = csr; csr &= ~rs1
csrrwi rd, csr, imm    # 读写立即数版本
csrrsi rd, csr, imm    # 置位立即数版本
csrrci rd, csr, imm    # 清位立即数版本
```

**重要的 S-mode CSR 寄存器**

我们将在本章使用以下 CSR 寄存器：

| CSR 名称   | 编号  | 作用                       |
| ---------- | ----- | -------------------------- |
| `sstatus`  | 0x100 | 状态寄存器（中断使能等）   |
| `sie`      | 0x104 | 中断使能寄存器             |
| `stvec`    | 0x105 | 异常处理入口地址           |
| `sscratch` | 0x140 | 临时寄存器（保存上下文）   |
| `sepc`     | 0x141 | 异常返回地址               |
| `scause`   | 0x142 | 异常原因                   |
| `stval`    | 0x143 | 异常相关值                 |
| `sip`      | 0x144 | 中断挂起寄存器             |
| `satp`     | 0x180 | 地址转换和保护（虚拟内存） |
