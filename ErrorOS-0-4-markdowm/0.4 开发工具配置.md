## 0.4 开发工具配置

#### 配置 VSCode 开发环境

**1. 安装vscode插件**

在 VSCode 中安装以下扩展：

1. **rust-analyzer**: Rust 语言服务器（智能提示、代码补全）
2. **CodeLLDB**: 调试器支持
3. **Even Better TOML**: TOML 文件语法高亮
4. **C/C++**: 用于查看汇编代码

**2. 创建工作区配置**

在项目根目录创建 `.vscode/settings.json`：

```json
{
    "rust-analyzer.cargo.target": "riscv64imac-unknown-none-elf",
    "rust-analyzer.cargo.allFeatures": true,
    "rust-analyzer.checkOnSave.allTargets": false,
    "rust-analyzer.checkOnSave.extraArgs": [
        "--target=riscv64imac-unknown-none-elf"
    ],
    "files.associations": {
        "*.ld": "c"
    }
}
```

**3. 创建构建任务**

创建 `.vscode/tasks.json`：

```json
{
    "version": "2.0.0",
    "tasks": [
        {
            "label": "Build Kernel",
            "type": "shell",
            "command": "cargo",
            "args": ["build", "--release"],
            "options": {
                "cwd": "${workspaceFolder}/os"
            },
            "group": {
                "kind": "build",
                "isDefault": true
            },
            "problemMatcher": ["$rustc"]
        },
        {
            "label": "Run in QEMU",
            "type": "shell",
            "command": "./run.sh",
            "dependsOn": ["Build Kernel"],
            "group": {
                "kind": "test",
                "isDefault": true
            }
        },
        {
            "label": "Clean",
            "type": "shell",
            "command": "cargo",
            "args": ["clean"],
            "options": {
                "cwd": "${workspaceFolder}/os"
            }
        }
    ]
}
```

---

#### 设置 GDB 调试工具

**步骤 1：安装 RISC-V GDB**

```bash
# Linux
sudo apt install gdb-multiarch

# macOS
brew install riscv64-elf-gdb
```

**步骤 2：创建 GDB 初始化脚本**

在项目根目录创建 `.gdbinit`：

```gdb
# 连接到 QEMU GDB 服务器
target remote localhost:1234

# 设置架构
set architecture riscv:rv64

# 加载符号
file os/target/riscv64imac-unknown-none-elf/release/os

# 在内核入口设置断点
break _start

# 自动显示寄存器
define hook-stop
    info registers
end

# 继续执行
continue
```

**步骤 3：创建调试脚本**

创建 `debug.sh`：

```bash
#!/bin/bash
# 启动 QEMU 调试模式

echo "Starting QEMU in debug mode..."
qemu-system-riscv64 \
    -machine virt \
    -cpu rv64 \
    -smp 1 \
    -m 128M \
    -bios default \
    -nographic \
    -serial mon:stdio \
    -kernel target/riscv64imac-unknown-none-elf/release/os \
    -s -S &

QEMU_PID=$!

echo "QEMU started with PID $QEMU_PID"
echo "Connecting GDB..."

# 启动 GDB
riscv64-unknown-elf-gdb \
    -ex "target remote localhost:1234" \
    -ex "file target/riscv64imac-unknown-none-elf/release/os" \
    -ex "break _start"

# 清理
kill $QEMU_PID 2>/dev/null
```

```bash
chmod +x debug.sh
```

---

#### 配置代码格式化工具

**步骤 1：创建 rustfmt 配置**

在项目根目录创建 `rustfmt.toml`：

```toml
edition = "2021"
max_width = 100
tab_spaces = 4
hard_tabs = false
newline_style = "Unix"
use_small_heuristics = "Default"
reorder_imports = true
reorder_modules = true
remove_nested_parens = true
format_strings = true
normalize_comments = true
wrap_comments = true
```

**步骤 2：格式化代码**

```bash
# 格式化整个项目
cargo fmt

# 检查格式（不修改）
cargo fmt -- --check
```

---

## 实验验证

### 验证环境配置

运行以下命令验证环境配置是否正确：

```bash
# 1. 检查 Rust 版本
rustc --version

# 2. 检查 RISC-V 目标
rustup target list | grep riscv64

# 3. 检查 QEMU 版本
qemu-system-riscv64 --version

# 4. 检查 rust-src 组件
rustup component list | grep rust-src

# 5. 尝试构建项目（即使失败也没关系，我们还没写代码）
cd os
cargo check
```
