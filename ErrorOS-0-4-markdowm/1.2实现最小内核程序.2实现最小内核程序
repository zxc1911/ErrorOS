## 1.2å®ç°æœ€å°å†…æ ¸ç¨‹åº

#### ç¼–å†™ RISC-V æ±‡ç¼–å…¥å£ç‚¹ (`_start`)

**èƒŒæ™¯çŸ¥è¯†**

RISC-V å¤„ç†å™¨å¯åŠ¨åï¼Œä¼šä»ç‰¹å®šåœ°å€å¼€å§‹æ‰§è¡Œã€‚åœ¨ QEMU virt æœºå™¨ä¸­ï¼š

1. OpenSBI å›ºä»¶åŠ è½½åˆ° `0x80000000`
2. OpenSBI åŠ è½½æˆ‘ä»¬çš„å†…æ ¸åˆ° `0x80200000`
3. è·³è½¬åˆ° `_start` ç¬¦å·å¼€å§‹æ‰§è¡Œ

**æ­¥éª¤ 1ï¼šä½¿ç”¨ `global_asm!` å®ç¼–å†™æ±‡ç¼–**

åœ¨ `main.rs` ä¸­æ·»åŠ ï¼š

```rust
use core::arch::global_asm;

// RISC-V æ±‡ç¼–å…¥å£ç‚¹
// å®šä¹‰åœ¨æ±‡ç¼–ä¸­ï¼Œè´Ÿè´£ï¼š
// - æ¸…é›¶ BSS æ®µ
// - è®¾ç½®æ ˆæŒ‡é’ˆ
// - è·³è½¬åˆ° kernel_main
global_asm!(
    ".section .text.entry",
    ".globl _start",
    "_start:",
    // è®¾ç½®æ ˆæŒ‡é’ˆ
    "   la sp, stack_end",
    // æ¸…é›¶ BSS æ®µ
    "   la t0, bss_start",
    "   la t1, bss_end",
    "1:",
    "   bgeu t0, t1, 2f",
    "   sd zero, (t0)",
    "   addi t0, t0, 8",
    "   j 1b",
    "2:",
    // è·³è½¬åˆ° kernel_main
    "   call kernel_main",
    // å¦‚æœè¿”å›ï¼Œè¿›å…¥æ­»å¾ªç¯
    "3:",
    "   wfi",
    "   j 3b",
);
```

**ä»£ç é€è¡Œè§£æ**

| æ±‡ç¼–æŒ‡ä»¤               | è¯´æ˜                                                |
| ---------------------- | --------------------------------------------------- |
| `.section .text.entry` | å°†ä»£ç æ”¾å…¥ `.text.entry` æ®µï¼ˆé“¾æ¥å™¨è„šæœ¬ä¸­æœ€å…ˆåŠ è½½ï¼‰ |
| `.globl _start`        | å£°æ˜ `_start` ä¸ºå…¨å±€ç¬¦å·ï¼ˆé“¾æ¥å™¨å¯è§ï¼‰              |
| `_start:`              | å…¥å£ç‚¹æ ‡ç­¾                                          |
| `la sp, stack_end`     | åŠ è½½æ ˆé¡¶åœ°å€åˆ°æ ˆæŒ‡é’ˆ `sp`                           |
| `la t0, bss_start`     | åŠ è½½ BSS æ®µèµ·å§‹åœ°å€åˆ°ä¸´æ—¶å¯„å­˜å™¨ `t0`                |
| `la t1, bss_end`       | åŠ è½½ BSS æ®µç»“æŸåœ°å€åˆ° `t1`                          |
| `bgeu t0, t1, 2f`      | å¦‚æœ `t0 >= t1`ï¼Œè·³è½¬åˆ°æ ‡ç­¾ `2`                     |
| `sd zero, (t0)`        | å°† 0 å†™å…¥åœ°å€ `t0`ï¼ˆ8 å­—èŠ‚ï¼‰                        |
| `addi t0, t0, 8`       | `t0` é€’å¢ 8 å­—èŠ‚                                    |
| `j 1b`                 | è·³è½¬å›æ ‡ç­¾ `1`ï¼ˆå‘åè·³è½¬ï¼‰                          |
| `call kernel_main`     | è°ƒç”¨ Rust çš„ `kernel_main` å‡½æ•°                     |
| `wfi`                  | Wait For Interruptï¼ˆä½åŠŸè€—ç­‰å¾…ï¼‰                    |
| `j 3b`                 | æ— é™å¾ªç¯                                            |

---

#### å®ç° BSS æ®µæ¸…é›¶

**èƒŒæ™¯çŸ¥è¯†**

BSSï¼ˆBlock Started by Symbolï¼‰æ®µåŒ…å«æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ã€‚C/Rust æ ‡å‡†è¦æ±‚ BSS æ®µåœ¨ç¨‹åºå¯åŠ¨æ—¶æ¸…é›¶ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦æ¸…é›¶ï¼Ÿ**

- å†…å­˜ä¸­å¯èƒ½åŒ…å«éšæœºæ•°æ®
- æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡åº”è¯¥æ˜¯ 0
- ç¡®ä¿ç¨‹åºè¡Œä¸ºå¯é¢„æµ‹

**å®ç°è¯´æ˜**

BSS æ®µæ¸…é›¶å·²ç»åœ¨ `_start` æ±‡ç¼–ä»£ç ä¸­å®ç°ï¼š

```asm
// æ¸…é›¶ BSS æ®µ
la t0, bss_start      # t0 = BSS èµ·å§‹åœ°å€
la t1, bss_end        # t1 = BSS ç»“æŸåœ°å€
1:
    bgeu t0, t1, 2f   # å¦‚æœ t0 >= t1ï¼Œè·³å‡ºå¾ªç¯
    sd zero, (t0)     # *t0 = 0ï¼ˆ8å­—èŠ‚ï¼‰
    addi t0, t0, 8    # t0 += 8
    j 1b              # å¾ªç¯
2:
```

**ç¬¦å·å®šä¹‰ä½ç½®**

è¿™äº›ç¬¦å·åœ¨é“¾æ¥å™¨è„šæœ¬ `linker-riscv64.ld` ä¸­å®šä¹‰ï¼š

```ld
.bss : ALIGN(4K) {
    bss_start = .;
    *(.bss .bss.*)
    *(.sbss .sbss.*)
    bss_end = .;
}
```

---

#### åˆå§‹åŒ–æ ˆæŒ‡é’ˆ

**èƒŒæ™¯çŸ¥è¯†**

æ ˆï¼ˆStackï¼‰ç”¨äºï¼š

- å‡½æ•°è°ƒç”¨çš„è¿”å›åœ°å€
- å±€éƒ¨å˜é‡å­˜å‚¨
- å‡½æ•°å‚æ•°ä¼ é€’

RISC-V ä½¿ç”¨ `sp` å¯„å­˜å™¨ä½œä¸ºæ ˆæŒ‡é’ˆï¼Œæ ˆå‘ä¸‹å¢é•¿ï¼ˆä»é«˜åœ°å€åˆ°ä½åœ°å€ï¼‰ã€‚

**å®ç°è¯´æ˜**

æ ˆæŒ‡é’ˆåˆå§‹åŒ–å·²åœ¨ `_start` ä¸­å®Œæˆï¼š

```asm
la sp, stack_end    # åŠ è½½æ ˆé¡¶åœ°å€åˆ° sp
```

**æ ˆç©ºé—´å®šä¹‰**

åœ¨é“¾æ¥å™¨è„šæœ¬ä¸­å®šä¹‰ï¼š

```ld
.stack : ALIGN(4K) {
    stack_start = .;
    . += 512K;        /* 512 KB æ ˆç©ºé—´ */
    stack_end = .;
}
```

**å¯è§†åŒ–æ ˆå¸ƒå±€**

```
é«˜åœ°å€ â†’ stack_end    â† sp åˆå§‹ä½ç½®
         â”‚           â”‚
         â”‚  512 KB   â”‚ æ ˆç©ºé—´
         â”‚   å¯ç”¨    â”‚
         â†“           â†“
ä½åœ°å€ â†’ stack_start
```

---

#### è·³è½¬åˆ° Rust `kernel_main`

**æ­¥éª¤ 1ï¼šå®šä¹‰ `kernel_main` å‡½æ•°**

åœ¨ `main.rs` ä¸­æ·»åŠ ï¼š

```rust
/// å†…æ ¸ä¸»å‡½æ•°
///
/// # åŠŸèƒ½
/// - åˆå§‹åŒ–å†…æ ¸
/// - æµ‹è¯•åŸºæœ¬åŠŸèƒ½
#[no_mangle]
pub extern "C" fn kernel_main() -> ! {
    // æš‚æ—¶ä½¿ç”¨æ­»å¾ªç¯
    loop {}
}
```

**ä»£ç è§£æ**

- `#[no_mangle]`: ç¦æ­¢ç¼–è¯‘å™¨ä¿®æ”¹å‡½æ•°åï¼ˆç¡®ä¿æ±‡ç¼–èƒ½æ‰¾åˆ°ï¼‰
- `extern "C"`: ä½¿ç”¨ C è°ƒç”¨çº¦å®šï¼ˆä¸æ±‡ç¼–å…¼å®¹ï¼‰
- `-> !`: æ°¸ä¸è¿”å›

**æ­¥éª¤ 2ï¼šç¼–è¯‘æµ‹è¯•**

```bash
cargo build --release
```

**æ­¥éª¤ 3ï¼šæŸ¥çœ‹ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶**

```bash
# æŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶ä¿¡æ¯
file target/riscv64imac-unknown-none-elf/release/os

# æŸ¥çœ‹ç¬¦å·è¡¨ï¼ˆç¡®è®¤ _start å’Œ kernel_main å­˜åœ¨ï¼‰
riscv64-unknown-elf-nm target/riscv64imac-unknown-none-elf/release/os | grep -E "(_start|kernel_main)"
```

é¢„æœŸè¾“å‡ºï¼š

```
0000000080200000 T _start
0000000080200xxx T kernel_main
```

---

**ğŸ” çŸ¥è¯†ç‚¹ï¼šRISC-V è°ƒç”¨çº¦å®š**

å‡½æ•°è°ƒç”¨æ—¶å¯„å­˜å™¨çš„ä½¿ç”¨ï¼š

| å¯„å­˜å™¨           | åç§°    | ç”¨é€”            | è°ƒç”¨è€…ä¿å­˜/è¢«è°ƒç”¨è€…ä¿å­˜ |
| ---------------- | ------- | --------------- | ----------------------- |
| `x0`             | `zero`  | ç¡¬ä»¶é›¶å¯„å­˜å™¨    | -                       |
| `x1`             | `ra`    | è¿”å›åœ°å€        | è°ƒç”¨è€…ä¿å­˜              |
| `x2`             | `sp`    | æ ˆæŒ‡é’ˆ          | è¢«è°ƒç”¨è€…ä¿å­˜            |
| `x8-x9`          | `s0-s1` | ä¿å­˜å¯„å­˜å™¨      | è¢«è°ƒç”¨è€…ä¿å­˜            |
| `x10-x17`        | `a0-a7` | å‡½æ•°å‚æ•°/è¿”å›å€¼ | è°ƒç”¨è€…ä¿å­˜              |
| `x5-x7, x28-x31` | `t0-t6` | ä¸´æ—¶å¯„å­˜å™¨      | è°ƒç”¨è€…ä¿å­˜              |
