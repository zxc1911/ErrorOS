## 0.2 QEMU模拟器配置

我们需要QEMU模拟器来模拟裸机环境

### 安装 QEMU RISC-V 版本

**Linux (Ubuntu/Debian)**

```bash
# 安装 QEMU RISC-V 版本
sudo apt update
sudo apt install qemu-system-riscv64

# 或从源代码编译最新版本
git clone https://gitlab.com/qemu-project/qemu.git
cd qemu
git checkout v8.1.0
./configure --target-list=riscv64-softmmu
make -j$(nproc)
sudo make install
```

**macOS**

使用Homebrew安装：

```bash
brew install qemu
```

---

### 验证 QEMU 功能

检查 QEMU 版本：

```bash
qemu-system-riscv64 --version
```

预期输出：

```
QEMU emulator version 7.0.0 (或更高版本)
```

查看支持的机器类型：

```bash
qemu-system-riscv64 -machine help
```

预期输出应包含：

```
virt                 RISC-V VirtIO board
```

测试 QEMU 启动：

```bash
qemu-system-riscv64 \
    -machine virt \
    -cpu rv64 \
    -smp 1 \
    -m 128M \
    -bios default \
    -nographic
```

你应该看到 OpenSBI 的启动信息。按 `Ctrl+A` 然后 `X` 退出。

---

### 配置 QEMU 启动脚本

在项目根目录创建 `run.sh`：

```bash
#!/bin/bash
# QEMU RISC-V 启动脚本

QEMU_ARGS=(
    -machine virt           # 使用 virt 虚拟机
    -cpu rv64               # RISC-V 64位 CPU
    -smp 1                  # 单核 CPU
    -m 128M                 # 128MB 内存
    -bios default           # 使用默认 BIOS (OpenSBI)
    -serial stdio           # 串口输出到标准输出
    -display default        # 显示窗口
    -kernel target/riscv64imac-unknown-none-elf/release/os
)

# 如果有额外参数，传递给 QEMU
if [ "$1" == "--debug" ]; then
    QEMU_ARGS+=(-s -S)      # -s: gdbserver on :1234, -S: 启动时暂停
fi

qemu-system-riscv64 "${QEMU_ARGS[@]}"
```

赋予执行权限：

```bash
chmod +x run.sh
```

创建无窗口运行脚本 `run-nographic.sh`：

```bash
#!/bin/bash
# QEMU RISC-V 启动脚本（无图形界面）

qemu-system-riscv64 \
    -machine virt \
    -cpu rv64 \
    -smp 1 \
    -m 128M \
    -bios default \
    -nographic \
    -serial mon:stdio \
    -kernel target/riscv64imac-unknown-none-elf/release/os
```

```bash
chmod +x run-nographic.sh
```
